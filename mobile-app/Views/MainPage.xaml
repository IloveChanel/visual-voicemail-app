<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:VisualVoicemailPro.ViewModels"
             xmlns:converters="clr-namespace:VisualVoicemailPro.Converters"
             x:Class="VisualVoicemailPro.Views.MainPage"
             Title="Visual Voicemail Pro"
             BackgroundColor="{StaticResource BackgroundPrimary}">

    <ContentPage.BindingContext>
        <vm:EnhancedMainViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:LanguageDisplayConverter x:Key="LanguageDisplayConverter" />
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
            <converters:SpamBorderConverter x:Key="SpamBorderConverter" />
            <converters:HighPriorityConverter x:Key="HighPriorityConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Padding="20" Spacing="20">
            
            <!-- Header Section -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackLayout Grid.Column="0">
                    <Label Text="ðŸŽ™ï¸ Visual Voicemail Pro" 
                           FontSize="28" 
                           FontAttributes="Bold" 
                           TextColor="{StaticResource Primary}" />
                    <Label Text="{Binding SubscriptionStatusText}" 
                           FontSize="14" 
                           TextColor="{StaticResource TextSecondary}" />
                </StackLayout>
                
                <Button Grid.Column="1"
                        Text="âš™ï¸" 
                        FontSize="20"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Primary}"
                        Command="{Binding UpgradeSubscriptionCommand}"
                        IsVisible="{Binding CurrentUser.IsSubscriptionActive, Converter={StaticResource InvertedBoolConverter}}" />
            </Grid>

            <!-- Language Selection Section -->
            <Frame BackgroundColor="{StaticResource BackgroundCard}" 
                   BorderColor="{StaticResource Primary}"
                   CornerRadius="15"
                   Padding="20">
                <StackLayout Spacing="15">
                    <Label Text="ðŸŒ Language Settings" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}" />
                    
                    <!-- Speech Recognition Language -->
                    <StackLayout>
                        <Label Text="Voicemail Transcription Language" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextPrimary}" />
                        <Picker x:Name="SpeechLanguagePicker"
                                Title="Select speech recognition language"
                                ItemsSource="{Binding SpeechLanguages}"
                                SelectedItem="{Binding SelectedSpeechLanguage}"
                                SelectedIndexChanged="OnSpeechLanguageSelected"
                                BackgroundColor="{StaticResource BackgroundSecondary}"
                                TextColor="{StaticResource TextPrimary}">
                            <Picker.ItemDisplayBinding>
                                <Binding Path="." Converter="{StaticResource LanguageDisplayConverter}" />
                            </Picker.ItemDisplayBinding>
                        </Picker>
                    </StackLayout>

                    <!-- Translation Language -->
                    <StackLayout IsVisible="{Binding CanUseAdvancedFeatures}">
                        <Label Text="Translation Target Language" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextPrimary}" />
                        <Picker x:Name="TranslationLanguagePicker"
                                Title="Select translation language"
                                ItemsSource="{Binding TranslationLanguages}"
                                SelectedItem="{Binding SelectedTranslationLanguage}"
                                SelectedIndexChanged="OnTranslationLanguageSelected"
                                BackgroundColor="{StaticResource BackgroundSecondary}"
                                TextColor="{StaticResource TextPrimary}">
                            <Picker.ItemDisplayBinding>
                                <Binding Path="." Converter="{StaticResource LanguageDisplayConverter}" />
                            </Picker.ItemDisplayBinding>
                        </Picker>
                    </StackLayout>

                    <!-- Upgrade Prompt for Free Users -->
                    <StackLayout IsVisible="{Binding CanUseAdvancedFeatures, Converter={StaticResource InvertedBoolConverter}}">
                        <Label Text="ðŸ”’ Translation requires Visual Voicemail Pro" 
                               FontSize="12" 
                               TextColor="{StaticResource Warning}"
                               HorizontalOptions="Center" />
                        <Button Text="Upgrade to Pro - $3.49/month"
                                Command="{Binding UpgradeSubscriptionCommand}"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                CornerRadius="20"
                                FontSize="14"
                                Margin="0,10,0,0" />
                    </StackLayout>
                </StackLayout>
            </Frame>

            <!-- Action Buttons -->
            <Grid ColumnSpacing="15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0"
                        Text="ðŸ”„ Refresh"
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        CornerRadius="10" />
                
                <Button Grid.Column="1"
                        Text="ðŸŽµ Process All"
                        Command="{Binding ProcessAllCommand}"
                        BackgroundColor="{StaticResource Success}"
                        TextColor="White"
                        CornerRadius="10"
                        IsEnabled="{Binding CanUseAdvancedFeatures}" />
                
                <Button Grid.Column="2"
                        Text="ðŸ“Š Analytics"
                        BackgroundColor="{StaticResource Accent}"
                        TextColor="White"
                        CornerRadius="10"
                        IsEnabled="{Binding CurrentUser.CanUseAnalytics}" />
            </Grid>

            <!-- Status Message -->
            <Label Text="{Binding StatusMessage}" 
                   FontSize="14" 
                   TextColor="{StaticResource TextSecondary}"
                   HorizontalOptions="Center"
                   IsVisible="{Binding IsProcessing, Converter={StaticResource InvertedBoolConverter}}" />
            
            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsProcessing}" 
                               Color="{StaticResource Primary}"
                               HorizontalOptions="Center" />

            <!-- Voicemail List -->
            <Label Text="Your Voicemails" 
                   FontSize="20" 
                   FontAttributes="Bold" 
                   TextColor="{StaticResource TextPrimary}"
                   Margin="0,20,0,10" />

            <!-- Filter Buttons -->
            <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <Button Text="All" Command="{Binding FilterCommand}" CommandParameter="all" 
                            BackgroundColor="{StaticResource BackgroundSecondary}" TextColor="{StaticResource TextPrimary}" />
                    <Button Text="Unread" Command="{Binding FilterCommand}" CommandParameter="unread"
                            BackgroundColor="{StaticResource BackgroundSecondary}" TextColor="{StaticResource TextPrimary}" />
                    <Button Text="Spam" Command="{Binding FilterCommand}" CommandParameter="spam"
                            BackgroundColor="{StaticResource Error}" TextColor="White" />
                    <Button Text="Favorites" Command="{Binding FilterCommand}" CommandParameter="favorites"
                            BackgroundColor="{StaticResource Warning}" TextColor="White" />
                    <Button Text="Important" Command="{Binding FilterCommand}" CommandParameter="important"
                            BackgroundColor="{StaticResource Success}" TextColor="White" />
                </StackLayout>
            </ScrollView>

            <!-- Voicemail Collection -->
            <CollectionView ItemsSource="{Binding FilteredVoicemails}" 
                           SelectionMode="Single"
                           SelectedItem="{Binding SelectedVoicemail}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,5,0,5" 
                               Padding="15" 
                               BackgroundColor="{StaticResource BackgroundCard}"
                               BorderColor="{Binding IsSpam, Converter={StaticResource SpamBorderConverter}}"
                               CornerRadius="12"
                               HasShadow="True">
                            <StackLayout Spacing="10">
                                
                                <!-- Header Row -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackLayout Grid.Column="0">
                                        <Label Text="{Binding CallerName, FallbackValue={Binding CallerNumber}}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="{Binding CallerNumber}" 
                                               FontSize="12" 
                                               TextColor="{StaticResource TextSecondary}" />
                                    </StackLayout>
                                    
                                    <Label Grid.Column="1"
                                           Text="ðŸ”¥" 
                                           FontSize="16"
                                           IsVisible="{Binding IsFavorite}" />
                                    
                                    <Label Grid.Column="2"
                                           Text="{Binding ReceivedAt, StringFormat='{0:MM/dd HH:mm}'}" 
                                           FontSize="12" 
                                           TextColor="{StaticResource TextSecondary}"
                                           VerticalOptions="Center" />
                                </Grid>

                                <!-- Status Badges -->
                                <StackLayout Orientation="Horizontal" Spacing="5">
                                    <Frame IsVisible="{Binding IsSpam}" 
                                           BackgroundColor="{StaticResource Error}" 
                                           Padding="6,2" 
                                           CornerRadius="8"
                                           HasShadow="False">
                                        <Label Text="SPAM" 
                                               TextColor="White" 
                                               FontSize="10" 
                                               FontAttributes="Bold" />
                                    </Frame>
                                    
                                    <Frame IsVisible="{Binding IsRead, Converter={StaticResource InvertedBoolConverter}}" 
                                           BackgroundColor="{StaticResource Primary}" 
                                           Padding="6,2" 
                                           CornerRadius="8"
                                           HasShadow="False">
                                        <Label Text="NEW" 
                                               TextColor="White" 
                                               FontSize="10" 
                                               FontAttributes="Bold" />
                                    </Frame>
                                    
                                    <Label Text="{Binding Category, StringFormat='ðŸ“‚ {0}'}" 
                                           FontSize="10" 
                                           TextColor="{StaticResource TextSecondary}"
                                           VerticalOptions="Center" />
                                    
                                    <Label Text="{Binding Priority, StringFormat='âš¡ {0}'}" 
                                           FontSize="10" 
                                           TextColor="{StaticResource TextSecondary}"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding Priority, Converter={StaticResource HighPriorityConverter}}" />
                                </StackLayout>

                                <!-- Transcription -->
                                <Frame IsVisible="{Binding Transcription, Converter={StaticResource StringToBoolConverter}}"
                                       BackgroundColor="{StaticResource BackgroundSecondary}" 
                                       Padding="12" 
                                       CornerRadius="8"
                                       HasShadow="False">
                                    <StackLayout Spacing="5">
                                        <Label Text="ðŸ“ Transcription:" 
                                               FontSize="12" 
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextSecondary}" />
                                        <Label Text="{Binding Transcription}" 
                                               FontSize="14" 
                                               TextColor="{StaticResource TextPrimary}"
                                               LineBreakMode="WordWrap" />
                                    </StackLayout>
                                </Frame>

                                <!-- Translation -->
                                <Frame IsVisible="{Binding TranslatedText, Converter={StaticResource StringToBoolConverter}}"
                                       BackgroundColor="{StaticResource BackgroundSecondary}" 
                                       Padding="12" 
                                       CornerRadius="8"
                                       HasShadow="False">
                                    <StackLayout Spacing="5">
                                        <Label Text="ðŸŒ Translation:" 
                                               FontSize="12" 
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Accent}" />
                                        <Label Text="{Binding TranslatedText}" 
                                               FontSize="14" 
                                               TextColor="{StaticResource TextPrimary}"
                                               LineBreakMode="WordWrap" />
                                    </StackLayout>
                                </Frame>

                                <!-- Action Buttons -->
                                <Grid ColumnSpacing="10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <Button Grid.Column="0"
                                            Text="ðŸŽµ" 
                                            FontSize="16"
                                            BackgroundColor="{StaticResource Primary}"
                                            TextColor="White"
                                            CornerRadius="8"
                                            HeightRequest="40" />
                                    
                                    <Button Grid.Column="1"
                                            Text="ðŸŽ™ï¸" 
                                            FontSize="16"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EnhancedMainViewModel}}, Path=TranscribeCommand}" 
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{StaticResource Success}"
                                            TextColor="White"
                                            CornerRadius="8"
                                            HeightRequest="40" />
                                    
                                    <Button Grid.Column="2"
                                            Text="ðŸŒ" 
                                            FontSize="16"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EnhancedMainViewModel}}, Path=TranslateCommand}" 
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{StaticResource Accent}"
                                            TextColor="White"
                                            CornerRadius="8"
                                            HeightRequest="40"
                                            IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type vm:EnhancedMainViewModel}}, Path=CanUseAdvancedFeatures}" />
                                    
                                    <Button Grid.Column="3"
                                            Text="â­" 
                                            FontSize="16"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EnhancedMainViewModel}}, Path=ToggleFavoriteCommand}" 
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{StaticResource Warning}"
                                            TextColor="White"
                                            CornerRadius="8"
                                            HeightRequest="40" />
                                    
                                    <Button Grid.Column="4"
                                            Text="ðŸ—‘ï¸" 
                                            FontSize="16"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EnhancedMainViewModel}}, Path=DeleteCommand}" 
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{StaticResource Error}"
                                            TextColor="White"
                                            CornerRadius="8"
                                            HeightRequest="40" />
                                </Grid>
                            </StackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
                <CollectionView.EmptyView>
                    <StackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="40">
                        <Label Text="ðŸ“­" FontSize="48" HorizontalOptions="Center" />
                        <Label Text="No voicemails yet" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextSecondary}"
                               HorizontalOptions="Center" />
                        <Label Text="Your voicemails will appear here" 
                               FontSize="14" 
                               TextColor="{StaticResource TextMuted}"
                               HorizontalOptions="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <!-- Premium Upgrade Banner (visible for free users) -->
            <Frame BackgroundColor="{StaticResource Primary}"
                   HasShadow="True"
                   CornerRadius="12"
                   Margin="10"
                   Padding="15"
                   IsVisible="{Binding ShowAds}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    
                    <StackLayout Grid.Column="0" VerticalOptions="Center">
                        <Label Text="ðŸš€ Upgrade to Premium" 
                               FontSize="16" 
                               FontAttributes="Bold"
                               TextColor="White" />
                        <Label Text="Remove ads â€¢ Unlimited transcriptions â€¢ Advanced features" 
                               FontSize="12" 
                               TextColor="White" 
                               Opacity="0.9" />
                        <Label Text="Only $3.49/month" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="White" />
                    </StackLayout>
                    
                    <Button Grid.Column="1"
                            Text="Upgrade"
                            FontSize="14"
                            FontAttributes="Bold"
                            Command="{Binding RemoveAdsCommand}"
                            BackgroundColor="White"
                            TextColor="{StaticResource Primary}"
                            CornerRadius="20"
                            HeightRequest="40"
                            WidthRequest="80" />
                </Grid>
            </Frame>

            <!-- Ad Status Display -->
            <Frame BackgroundColor="{StaticResource BackgroundSecondary}"
                   HasShadow="False"
                   CornerRadius="8"
                   Margin="10,5"
                   Padding="10"
                   IsVisible="{Binding IsPremiumUser}">
                <StackLayout Orientation="Horizontal" HorizontalOptions="Center">
                    <Label Text="âœ¨" FontSize="16" />
                    <Label Text="{Binding AdStatusText}" 
                           FontSize="14" 
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}"
                           VerticalOptions="Center" />
                </StackLayout>
            </Frame>

            <!-- Banner Ad Container (visible for free users) -->
            <Grid x:Name="BannerAdContainer"
                  HeightRequest="50"
                  BackgroundColor="{StaticResource BackgroundSecondary}"
                  IsVisible="{Binding ShowAds}"
                  Margin="0,5,0,0">
                <Label Text="ðŸ“¢ Advertisement" 
                       FontSize="12"
                       TextColor="{StaticResource TextMuted}"
                       HorizontalOptions="Center"
                       VerticalOptions="Center" />
            </Grid>

            <!-- Restore Purchases Button (for premium users) -->
            <Button Text="Restore Purchases"
                    Command="{Binding RestorePurchasesCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource TextMuted}"
                    FontSize="12"
                    IsVisible="{Binding ShowAds}"
                    Margin="10,5" />

        </StackLayout>
    </ScrollView>

</ContentPage>